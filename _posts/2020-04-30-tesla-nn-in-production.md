---
keywords: fastai
description: This notebook summarizes the recent spectacular talk of Andrej Kaparthy showing how Tesla is using neural network at scale in production.
title: How Tesla uses neural network at scale in production
toc: true 
badges: true
comments: true
categories: [self-learning]
image: images/selfdrivingcar.png
hide: false
nb_path: _notebooks/2020-04-30-tesla-nn-in-production.ipynb
layout: notebook
---

<!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2020-04-30-tesla-nn-in-production.ipynb
-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>At the <a href="http://scaledml.org/2020/">Scaled Machine Learning Conference</a> this year 2020, Andrej Kaparthy - Director of AI at Tesla - has given a <a href="https://www.youtube.com/watch?time_continue=1&amp;v=hx7BXih7zx8&amp;feature=emb_logo">spectacular talk</a> about how Tesla is applying AI into their system. There are so much information and distilled knowlege came out from this talk which made me can not resist to write this blog post. if you want to access to other talks from Scaled Machine Learning Conference, go <a href="https://info.matroid.com/scaledml-media-archive-preview">here</a>.
{% include note.html content='all the images used in this note are from the slide used in Andrej&#8217;s video.' %}</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Overview">Overview<a class="anchor-link" href="#Overview"> </a></h2><p>The talk is about <code>AI for Full-Self Driving</code> where Andrej talked about how Tesla are improving the safety and convenience of driving, how they deploy deep learning into production and supports all the features of autopilot today, how the neural net is eating through the software stack and how they are putting vision and AI at the front and center of this effort.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Full self-driving is a non-trivial task which requires you to not only follow the driving law but also to satisfy  massive number of users. Tesla has built their cars to be like a real computer with eyes(cameras) on it. Beside the main functions of self-driving, they also have other great functionalities such as active safely (e.g auto detect pedestrians even when self-driving mode is off) and auto parking (auto search for the parking lot).</p>
<p>Different with other companies where Lidar is used as car's eyes, Tesla is using <code>vision-based</code> approach with cameras. The advantage of this approach is its scalable where cameras can be easily installed in millions of car. 
{% include note.html content='Briefly describe about Lidar, it shoots out the laser, create point cloud map and print out high definition map.' %}</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><img src="/blog/images/copied_from_nb/data/tesla/visionapproach.png" alt=""></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="HydraNet">HydraNet<a class="anchor-link" href="#HydraNet"> </a></h2><p>Using the images from cameras, Tesla AI team has built a very large network for detecting objects that their cars have to encounter on the street. This network has shared backbone and multiple heads, each of them is responsible for a number of tasks. As you can see in the image below, in order to make decision the car needs to detect a lot of objects around it such as lane lines, static objects, road signs, crosswalks, etc. And for each detecting task, there can be multiple subtasks come with it and if we list them out all, the number can be even thousand of tasks.</p>
<p><img src="/blog/images/copied_from_nb/data/tesla/hydranet.png" alt=""></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Data-engine-and-operation-vacation">Data engine and operation vacation<a class="anchor-link" href="#Data-engine-and-operation-vacation"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>In order to boost the performance of <code>HydraNet</code>, Tesla needs a lot of data. So you have thousand of tasks to solve and each of them requires thousands of images. Wouldn't you need thousand of engineer to make it work?<br>
{% include note.html content='Tesla has around dozens of engineer! Small team but super elite.' %}</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>In order to deal with such large amount of work with not so many engineers, Andrej has introduced the concept of <code>operation vacation</code> and <code>data engine</code>.</p>
<p><code>Operation vacation</code> means the engineers might take vacation while the system still operate well. They have tried to develop as much automation machinery to support the development of new tasks and remove engineers from that loop. They have built infrastructure so that the labeling team, PMs can actually use that infrastructure to create new detectors whenever they have new tasks. For every new task, there will be a latency for it to actually work and they know exactly the process for getting a new task to work. It is fully automatic.</p>
<p>Getting an example of new task detecting <code>caution lights</code>. Tesla has built a family of prototype infrastructure for different tasks. For example this <code>caution lights</code> is treated as landmark task and if it is a member of task family then all the infrastructure for it already in place so they just plug-and-play landmark prototype infrastructure and go through the <code>Data Engine</code>.</p>
<p><img src="/blog/images/copied_from_nb/data/tesla/op_vac_dataengine.png" alt=""></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><code>Data Engine</code> is the process by which they iteractively apply active learning to source additional examples in cases detector misbehaving.<br>
Breaking down steps of applying data engine for the task detecting <code>caution lights</code>:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">-</span> <span class="n">Init</span> <span class="n">new</span> <span class="n">layer</span> <span class="n">of</span> <span class="n">annotation</span><span class="p">:</span> <span class="n">CAUTION_LIGHT</span> <span class="p">(</span><span class="n">LANDMARK</span><span class="p">)</span>
<span class="o">-</span> <span class="n">Label</span> <span class="n">a</span> <span class="n">seed</span> <span class="nb">set</span> <span class="n">of</span> <span class="n">images</span>
<span class="o">-</span> <span class="n">Develop</span> <span class="n">a</span> <span class="n">seed</span> <span class="nb">set</span> <span class="n">of</span> <span class="n">unit</span> <span class="n">tests</span>
<span class="o">-</span> <span class="n">Train</span> <span class="n">network</span> <span class="n">head</span> <span class="n">on</span> <span class="n">current</span> <span class="n">data</span> 
<span class="o">-</span> <span class="n">While</span> <span class="n">QA</span> <span class="n">does</span> <span class="ow">not</span> <span class="n">sign</span> <span class="n">off</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">While</span> <span class="n">unit</span> <span class="n">tests</span> <span class="n">fail</span><span class="p">:</span>
        <span class="o">-</span> <span class="n">Deploy</span> <span class="n">a</span> <span class="n">trigger</span><span class="p">(</span><span class="n">an</span> <span class="n">approximate</span> <span class="n">detector</span> <span class="n">trained</span> <span class="n">offline</span><span class="p">)</span> 
          <span class="n">to</span> <span class="n">the</span> <span class="n">fleet</span><span class="p">(</span><span class="n">millions</span> <span class="n">of</span> <span class="n">Tesla</span> <span class="n">car</span> <span class="n">running</span> <span class="n">on</span> <span class="n">the</span> <span class="n">street</span><span class="p">)</span> 
          <span class="ow">in</span> <span class="n">order</span> <span class="n">to</span> <span class="n">source</span> <span class="n">more</span> <span class="n">images</span> <span class="ow">in</span> <span class="n">failing</span> <span class="n">scenarios</span><span class="o">.</span> 
        <span class="o">-</span> <span class="n">Label</span> <span class="n">the</span> <span class="n">resulting</span> <span class="n">images</span> <span class="ow">and</span> <span class="n">incorporate</span> <span class="n">them</span> <span class="n">into</span> <span class="n">the</span> <span class="n">training</span> <span class="nb">set</span><span class="o">.</span>
        <span class="o">-</span> <span class="n">Retrain</span> <span class="n">network</span> <span class="n">on</span> <span class="n">data</span> 
        <span class="o">-</span> <span class="n">Enrich</span><span class="o">/</span><span class="n">grow</span> <span class="nb">set</span> <span class="n">of</span> <span class="n">unit</span> <span class="n">tests</span>
    <span class="o">-</span> <span class="n">Deploy</span> <span class="n">to</span> <span class="n">run</span> <span class="n">on</span> <span class="n">the</span> <span class="n">FSD</span> <span class="n">computer</span>
    <span class="o">-</span> <span class="p">(</span><span class="n">Optional</span><span class="p">)</span> <span class="n">Deploy</span> <span class="n">to</span> <span class="n">the</span> <span class="n">fleet</span> <span class="ow">in</span> <span class="n">shadow</span> <span class="n">mode</span>
    <span class="o">-</span> <span class="n">Collect</span> <span class="n">telemetry</span> <span class="ow">and</span> <span class="n">evaluate</span> <span class="n">the</span> <span class="n">performance</span> <span class="n">of</span> <span class="n">the</span> <span class="n">feature</span>
<span class="o">-</span> <span class="n">Ship</span> <span class="n">feature</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>{% include note.html content='Data Engine helps to accumulate large dataset in the full tail distribution.' %}</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Evaluation-metrics">Evaluation metrics<a class="anchor-link" href="#Evaluation-metrics"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>In the above part, we have seen the tremendous efforts that Andrej's team has been working on for growing their training set. But Tesla has also placed just as much work into massaging the test set as they do in the training set. They spent a lot of time, inspired by test-driven development, to build out very complicated test set. Their test set is treated like unit tests which has to cover all cases. This set is so important and it is the objective for the whole system improvement. Whether you are going in right or wrong direction, it all depends on the quality of the test set.</p>
<p>A mechanism has been built for creating and massaging the test set. And this set is a growing collection thanks to the fleet running along the street and encounters different problems daily.</p>
<p>Just reporting the loss function or the mean average precision on the test set is not enough for Tesla. Below is an example of test set for <code>stop sign detector</code> which is actually broken down into all these different issues like heavy rain/snow, heavily occluded, tilted stop signs and each of them is tracked separately and is pursued one-by-one with data engine to actually make them work.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>{% include image.html height="500" max-width="500" file="/blog/images/copied_from_nb/data/tesla/eval_metric.png" %}</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Modeling:-Bird-'s-Eye-View-networks">Modeling: Bird 's Eye View networks<a class="anchor-link" href="#Modeling:-Bird-'s-Eye-View-networks"> </a></h2><p>In this part, Andrej talked about how the neural network has to change in order to actually support full self-driving.</p>
<p>The self driving system can not just work with raw predictions from 2d pixel space, it is needed to project them out to some kind of top-down view. A traditional approach is to create <code>occupancy tracker</code> where 2D images are projected into 3D and stitched up across cameras and then across time. This tracker will keep the temporal context  and create a small local map which helps the car winds its way thru the parking lot for example(see top left image below).<br>
However, there are a lot of problems doing the stitching because these cameras are pointing in arbitrary directions and it is very hard to align them across cameras. Very difficult to develop.</p>
<p>{% include image.html height="400" max-width="400" file="/blog/images/copied_from_nb/data/tesla/occupance_tracking.png" %}</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>So Tesla's AI team has decided to move from occupancy tracker (software 1.0 approach) to BEV Net (software 2.0 approach) and they see typically that works really well.</p>
<p>Briefly remind about software 1.0 and software 2.0 that Andrej has many times mentioned in his previous talks. Software 1.0 is the traditional way of coding where developers directly write the code to create the software.
Software 2.0 is the neural network-based approach where developers indirectly write the code. The optimization algorithm is the one compile data into the code. Software 2.0 is extremely useful when the problem is so messy and super hard to code. The trend is moving toward software 2.0 but each of them has their own pros and cons. The best way is still to combine them in a clever way.
<img src="/blog/images/copied_from_nb/data/tesla/BEV.png" alt=""></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>As shown in the image above, images from cameras are fed to backbone and then going to a <code>Fusion layer</code> that stitches up the feature maps accross different view and also does the projection from image space to bird eye view. And then you have a <code>Temporal module</code> to actually smooth out these predictions. The <code>BEV Net</code> decoder actually create top-down space. That is how we can directly predict objects in top-down view from camera images.</p>
<p>Most of the things that Andrej has described so far reply primarily on supervise learning where Tesla AI team has spent efforts to create and massage massive dataset. However, he have seen a lot of progress today in self-supervise learning so he wants to leverage some of that to speed up the process and the rate at which they learn from very little supervised data. So let's wait for Andrej's next talk with self-supervised models deployed in Tesla autopilot system.</p>

</div>
</div>
</div>
</div>
 

